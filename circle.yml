machine:
  timezone: Asia/Tokyo
  services:
    - docker

dependencies:
  override:
    - docker info
    - docker build --rm=false -t q3a-server:latest ./

test:
  override:
    - docker build --rm=false -t q3a-server:latest -f ./test/Dockerfile.test ./test
#    - docker run -it --name q3a-server-runner -p 27960:27960/udp q3a-server:latest server

deployment:
  development:
    branch: development
    commands:
      - $(aws ecr get-login --region ap-northeast-1)
      - docker tag q3a-server:latest 324996458579.dkr.ecr.ap-northeast-1.amazonaws.com/quake3/server:latest
      - docker push 324996458579.dkr.ecr.ap-northeast-1.amazonaws.com/quake3/server:latest
  staging:
    branch: staging
    commands:
      - $(aws ecr get-login --region ap-northeast-1)
      - docker tag q3a-server:latest 324996458579.dkr.ecr.ap-northeast-1.amazonaws.com/quake3/server:latest
      - docker push 324996458579.dkr.ecr.ap-northeast-1.amazonaws.com/quake3/server
  production:
    branch: master
    commands:
      - $(aws ecr get-login --region ap-northeast-1)
      - docker tag q3a-server:latest 324996458579.dkr.ecr.ap-northeast-1.amazonaws.com/quake3/server:latest
      - docker push 324996458579.dkr.ecr.ap-northeast-1.amazonaws.com/quake3/server:latest
